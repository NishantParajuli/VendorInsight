{% block content %}
<h2>Vendor Analytics</h2>

<style>
.chart-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.chart-item {
    background-color: #f5f5f5;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
</style>

<div class="chart-grid">
    {% for category, data in category_sales_predictions.items %}
        <div class="chart-item">
            <h4>{{ category }}</h4>
            <canvas id="salesChart_{{ category }}"></canvas>
        </div>
    {% endfor %}
</div>

<div>
    <h4>Overall Vendor Sentiment</h4>
    <canvas id="overallSentimentChart"></canvas>
    <button id="detailsButton">Details</button>
    <div id="productSentimentDetails" style="display: none;">
        {% for product in product_sentiment_data %}
            {% if product.sadness > 0 or product.joy > 0 or product.love > 0 or product.anger > 0 or product.fear > 0 or product.surprise > 0 %}
                <div>
                    <h5>{{ product.name }}</h5>
                    <canvas id="productSentimentChart_{{ product.id }}"></canvas>
                </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<div>
    <h3>Customer Segmentation</h3>
    <canvas id="clusterChart"></canvas>
    <table>
        <thead>
            <tr>
                <th>Cluster</th>
                <th>Average Age</th>
                <th>Average Total Order</th>
                <th>Average Order Frequency</th>
                <th>Average Gender</th>
            </tr>
        </thead>
        <tbody>
            {% for cluster in cluster_averages %}
            <tr>
                <td>{{ cluster.cluster }}</td>
                <td>{{ cluster.age|floatformat:2 }}</td>
                <td>{{ cluster.total_order_amount|floatformat:2 }}</td>
                <td>{{ cluster.order_frequency|floatformat:2 }}</td>
                <td>{{ cluster.gender }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div>
    <h3>Inventory Management</h3>
    <table>
        <thead>
            <tr>
                <th>Product</th>
                <th>Current Stock</th>
                <th>Safety Stock Level</th>
                <th>Reorder Point</th>
                <th>Future Predictions</th>
            </tr>
        </thead>

        <tbody>
            {% for item in page_obj %}
            <tr>
                <td><a href="#" onclick="showPredictions({{ item.product_id }})">{{ item.product_name }}</a></td>
                <!-- ... (existing code) ... -->
                <td>{{ item.product_name }}</td>
                <td>{{ item.current_stock }}</td>
                <td>{{ item.safety_stock_level }}</td>
                <td>{{ item.reorder_point }}</td>
            </tr>
            <tr id="predictions-{{ item.product_id }}" style="display: none;">
                <td colspan="5">
                    <h4>Future Predictions:</h4>
                    <ul>
                        {% for prediction in item.future_predictions %}
                        <li>{{ prediction }}</li>
                        {% endfor %}
                    </ul>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="pagination">
        <span class="step-links">
            {% if page_obj.has_previous %}
                <a href="?page=1">&laquo; First</a>
                <a href="?page={{ page_obj.previous_page_number }}">Previous</a>
            {% endif %}

            <span class="current-page">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
            </span>

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}">Next</a>
                <a href="?page={{ page_obj.paginator.num_pages }}">Last &raquo;</a>
            {% endif %}
        </span>
    </div>
    
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>

    function showPredictions(productId) {
        var predictionsRow = document.getElementById('predictions-' + productId);
        if (predictionsRow.style.display === 'none') {
            predictionsRow.style.display = 'table-row';
        } else {
            predictionsRow.style.display = 'none';
        }
    }

    // Sales prediction charts for each category
    {% for category, data in category_sales_predictions.items %}
        var salesDates_{{ category }} = {{ data.dates|safe }};
        var salesPredictions_{{ category }} = {{ data.predictions|safe }};
        var salesChart_{{ category }} = new Chart(document.getElementById('salesChart_{{ category }}'), {
            type: 'line',
            data: {
                labels: salesDates_{{ category }},
                datasets: [{
                    label: 'Sales Predictions for {{ category }}',
                    data: salesPredictions_{{ category }},
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    {% endfor %}

    var overallSentimentData = [
        {% for sentiment in overall_sentiment_counts %}
            {{ sentiment.total }},
        {% endfor %}
    ];

    var overallSentimentLabels = [
        {% for sentiment in overall_sentiment_counts %}
            '{{ sentiment.sentiment }}',
        {% endfor %}
    ];

    var overallSentimentChart = new Chart(document.getElementById('overallSentimentChart'), {
        type: 'pie',
        data: {
            labels: overallSentimentLabels,
            datasets: [{
                data: overallSentimentData,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)'
                ],
                borderWidth: 1
            }]
        }
    });

    var detailsButton = document.getElementById('detailsButton');
    var productSentimentDetails = document.getElementById('productSentimentDetails');

    detailsButton.addEventListener('click', function() {
        if (productSentimentDetails.style.display === 'none') {
            productSentimentDetails.style.display = 'block';
        } else {
            productSentimentDetails.style.display = 'none';
        }
    });

    {% for product in product_sentiment_data %}
        {% if product.sadness > 0 or product.joy > 0 or product.love > 0 or product.anger > 0 or product.fear > 0 or product.surprise > 0 %}
            var productSentimentData_{{ product.id }} = [
                {{ product.sadness }},
                {{ product.joy }},
                {{ product.love }},
                {{ product.anger }},
                {{ product.fear }},
                {{ product.surprise }}
            ];

            var productSentimentChart_{{ product.id }} = new Chart(document.getElementById('productSentimentChart_{{ product.id }}'), {
                type: 'pie',
                data: {
                    labels: ['Sadness', 'Joy', 'Love', 'Anger', 'Fear', 'Surprise'],
                    datasets: [{
                        data: productSentimentData_{{ product.id }},
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)'
                        ],
                        borderWidth: 1
                    }]
                }
            });
        {% endif %}
    {% endfor %}

    var clusterData = {{ customer_segmentation.data|safe }};
    var clusterLabels = {{ customer_segmentation.clusters|safe }};

    var clusterChart = new Chart(document.getElementById('clusterChart'), {
        type: 'scatter',
        data: {
            datasets: clusterLabels.map(function(label) {
                return {
                    label: 'Cluster ' + label,
                    data: clusterData.filter(function(customer) {
                        return customer.cluster === label;
                    }).map(function(customer) {
                        return {
                            x: customer.pca_x,
                            y: customer.pca_y,
                        };
                    }),
                    backgroundColor: getColor(label)
                };
            })
        },
        options: {
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom'
                },
                y: {
                    type: 'linear',
                    position: 'left'
                },
            }
        }
    });

    function getColor(label) {
        var colors = ['rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)', 'rgba(75, 192, 192, 0.8)'];
        return colors[label];
    }
</script>
{% endblock %}